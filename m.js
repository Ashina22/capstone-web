"admin": { lat: 8.957250380365862,  lng: 125.59764832350852,  info: "Admin", image: "img/canteen.jpg", link: "oval.html" },
      "anex 2": { lat: 8.954527524733473, lng:  125.59807198444454, info: "Anex 2", image: "img/anex.jpg", link: "http://example.com/anex" }, 
      "batok hall": { lat: 8.957901790781143,  lng: 125.59720648660846, info: "Batok Hall", image: "img/canteen.jpg", link: "oval.html" }, 
      "villares": { lat: 8.953157960469824,  lng: 125.59738112140803,  info: "CSU Villares Building", image: "img/canteen.jpg", link: "oval.html" }, 
      "csu main h.e.r.o. learning commons": { lat: 8.95786387399443,  lng: 125.59635007361663, info: "CSU Main H.E.R.O. Learning Commons", image: "img/canteen.jpg", link: "lib.html" },
      "cas building": { lat: 8.955575598052341, lng: 125.59664046282884, info: "CAS Building", image: "", link: "" },
      "college of computing and information sciences": { lat: 8.9554, lng: 125.5978, info: "College of Computing and Information Sciences", image: "img/ccis.jpg", link: "ccis.html" },
      "oval": { lat: 8.9569, lng: 125.5964, info: "OvaL", image: "img/csu.jpg", link: "ccis.html" },
      "canteen": { lat: 8.957376450320611, lng: 125.59566892198143, info: "Canteen", image: "img/canteen.jpg", link: "oval.html" },
      "anex": { lat: 8.956526045261818, lng: 125.59551789945878, info: "Anex", image: "img/anex.jpg", link: "http://example.com/anex" },
      "greengate": { lat: 8.957175544666113, lng: 125.59875086836958, info: "Greengate", image: "img/greengate.jpg", link: "http://example.com/greengate" },
      "osas": { lat: 8.956938598181836, lng: 125.5974861856326, info: "Osas", image: "img/osas.jpg", link: "http://example.com/osas" },
      "eco hall": { lat: 8.955018346783993, lng: 125.5969820861699, info: "Eco Hall", image: "img/osas.jpg", link: "http://example.com/osas" },
      "sports": { lat: 8.955562274721453, lng: 125.59594834589646, info: "Sports Office", image: "img/osas.jpg", link: "http://example.com/osas" },
      "csu main gymnasium and cultural center": { lat: 8.955977741789837,  lng: 125.59566640516326, info: "CSU Main Gymnasium and Cultural Center", image: "img/osas.jpg", link: "http://example.com/osas" },
      "college of education (ced)": { lat: 8.959289352385552,   lng: 125.59702311903386, info: "College of Education (Ced)", image: "img/osas.jpg", link: "http://example.com/osas" },
      "department of science and technology caraga region(dost)": { lat: 8.953213412910166,  lng: 125.5982116566809, info: "Department of Science and Technology Caraga Region(DOST)", image: "img/osas.jpg", link: "http://example.com/osas" },


      "admin": { lat: 8.957250380365862,  lng: 125.59764832350852,  info: "Admin", image: "img/canteen.jpg", link: "oval.html" },
      "anex 2": { lat: 8.954527524733473, lng:  125.59807198444454, info: "Anex 2", image: "img/anex.jpg", link: "http://example.com/anex" }, 
      "batok hall": { lat: 8.957901790781143,  lng: 125.59720648660846, info: "Batok Hall", image: "img/canteen.jpg", link: "oval.html" }, 
      "villares": { lat: 8.953157960469824,  lng: 125.59738112140803,  info: "CSU Villares Building", image: "img/canteen.jpg", link: "oval.html" }, 
      "csu main h.e.r.o. learning commons": { lat: 8.95786387399443,  lng: 125.59635007361663, info: "CSU Main H.E.R.O. Learning Commons", image: "img/canteen.jpg", link: "lib.html" },
      "cas building": { lat: 8.955575598052341, lng: 125.59664046282884, info: "CAS Building", image: "", link: "" },
      "college of computing and information sciences": { lat: 8.9554, lng: 125.5978, info: "College of Computing and Information Sciences", image: "img/ccis.jpg", link: "ccis.html" },
      "oval": { lat: 8.9569, lng: 125.5964, info: "OvaL", image: "img/csu.jpg", link: "ccis.html" },
      "canteen": { lat: 8.957376450320611, lng: 125.59566892198143, info: "Canteen", image: "img/canteen.jpg", link: "oval.html" },
      "anex": { lat: 8.956526045261818, lng: 125.59551789945878, info: "Anex", image: "img/anex.jpg", link: "http://example.com/anex" },
      "greengate": { lat: 8.957175544666113, lng: 125.59875086836958, info: "Greengate", image: "img/greengate.jpg", link: "http://example.com/greengate" },
      "osas": { lat: 8.956938598181836, lng: 125.5974861856326, info: "Osas", image: "img/osas.jpg", link: "http://example.com/osas" },
      "eco hall": { lat: 8.955018346783993, lng: 125.5969820861699, info: "Eco Hall", image: "img/osas.jpg", link: "http://example.com/osas" },
      "sports": { lat: 8.955562274721453, lng: 125.59594834589646, info: "Sports Office", image: "img/osas.jpg", link: "http://example.com/osas" },
      "csu main gymnasium and cultural center": { lat: 8.955977741789837,  lng: 125.59566640516326, info: "CSU Main Gymnasium and Cultural Center", image: "img/osas.jpg", link: "http://example.com/osas" },
      "college of education (ced)": { lat: 8.959289352385552,   lng: 125.59702311903386, info: "College of Education (Ced)", image: "img/osas.jpg", link: "http://example.com/osas" },
      "department of science and technology caraga region(dost)": { lat: 8.953213412910166,  lng: 125.5982116566809, info: "Department of Science and Technology Caraga Region(DOST)", image: "img/osas.jpg", link: "http://example.com/osas" },


      { name: "Admin", lat: 8.957250380365862, lng: 125.59764832350852, info: "Admin", image: "img/canteen.jpg", link: "oval.html" },
    { name: "Batok hall", lat: 8.957901790781143,  lng: 125.59720648660846, info: "Batok Hall", image: "img/canteen.jpg", link: "oval.html" },
    { name: "College of Education (Ced)", lat: 8.959289352385552,   lng: 125.59702311903386, info: "College of Education", image: "img/canteen.jpg", link: "lib.html" },
    { name: "csu main h.e.r.o. learning commons", lat: 8.95786387399443, lng: 125.59635007361663, info: "CSU Main H.E.R.O. Learning Commons", image: "img/canteen.jpg", link: "lib.html" },
    { name: "cas building", lat: 8.955575598052341, lng: 125.59664046282884, info: "CAS Building", image: "", link: "" },
    { name: "college of computing and information sciences", lat: 8.9554, lng: 125.5978, info: "College of Computing and Information Sciences", image: "img/ccis.jpg", link: "ccis.html" },
    { name: "osas", lat: 8.956938598181836, lng: 125.5974861856326, info: "Osas", image: "img/osas.jpg", link: "http://example.com/osas" },
    { name: "eco hall", lat: 8.955018346783993, lng: 125.5969820861699, info: "Eco Hall", image: "img/osas.jpg", link: "http://example.com/osas" },
    { name: "Masawa Hall", lat: 8.955532271257468, lng: 125.59851599862621, info: "Masawa Hall", image: "img/osas.jpg", link: "http://example.com/osas" },
    { name: "CSU Main Gymnasium and Cultural Center", lat: 8.955977741789837,  lng: 125.59566640516326, info: "CSU Main Gymnasium and Cultural Center", image: "img/osas.jpg", link: "http://example.com/osas" },
    { name: "Department of Science and Technology Caraga Region", lat: 8.953213412910166,  lng: 125.5982116566809, info: "Department of Science and Technology Caraga Region", image: "img/osas.jpg", link: "http://example.com/osas" },



    // Modified getDirections function (old)
async function getDirections() {
  const startInput = document.getElementById("start-input").value.trim().toLowerCase();
  const useMyLocation = document.getElementById("use-my-location").checked;
  const endInput = document.getElementById("end-input").value.trim().toLowerCase();

  let startLocation;
  let endMarkers = markers.filter(m => m.info.toLowerCase().includes(endInput));

  const searchLocations = {
      "admin": { lat: 8.957250380365862,  lng: 125.59764832350852,  info: "Admin", image: "img/canteen.jpg", link: "oval.html" },
      "anex 2": { lat: 8.954527524733473, lng:  125.59807198444454, info: "Anex 2", image: "img/anex.jpg", link: "http://example.com/anex" }, 
      "batok hall": { lat: 8.957901790781143,  lng: 125.59720648660846, info: "Batok Hall", image: "img/canteen.jpg", link: "oval.html" }, 
      "villares": { lat: 8.953157960469824,  lng: 125.59738112140803,  info: "CSU Villares Building", image: "img/canteen.jpg", link: "oval.html" }, 
      "csu main h.e.r.o. learning commons": { lat: 8.95786387399443,  lng: 125.59635007361663, info: "CSU Main H.E.R.O. Learning Commons", image: "img/canteen.jpg", link: "lib.html" },
      "cas building": { lat: 8.955575598052341, lng: 125.59664046282884, info: "CAS Building", image: "", link: "" },
      "college of computing and information sciences": { lat: 8.9554, lng: 125.5978, info: "College of Computing and Information Sciences", image: "img/ccis.jpg", link: "ccis.html" },
      "oval": { lat: 8.9569, lng: 125.5964, info: "OvaL", image: "img/csu.jpg", link: "ccis.html" },
      "canteen": { lat: 8.957376450320611, lng: 125.59566892198143, info: "Canteen", image: "img/canteen.jpg", link: "oval.html" },
      "anex": { lat: 8.956526045261818, lng: 125.59551789945878, info: "Anex", image: "img/anex.jpg", link: "http://example.com/anex" },
      "greengate": { lat: 8.957175544666113, lng: 125.59875086836958, info: "Greengate", image: "img/greengate.jpg", link: "http://example.com/greengate" },
      "osas": { lat: 8.956938598181836, lng: 125.5974861856326, info: "Osas", image: "img/osas.jpg", link: "http://example.com/osas" },
      "eco hall": { lat: 8.955018346783993, lng: 125.5969820861699, info: "Eco Hall", image: "img/osas.jpg", link: "http://example.com/osas" },
      "sports": { lat: 8.955562274721453, lng: 125.59594834589646, info: "Sports Office", image: "img/osas.jpg", link: "http://example.com/osas" },
      "csu main gymnasium and cultural center": { lat: 8.955977741789837,  lng: 125.59566640516326, info: "CSU Main Gymnasium and Cultural Center", image: "img/osas.jpg", link: "http://example.com/osas" },
      "college of education (ced)": { lat: 8.959289352385552,   lng: 125.59702311903386, info: "College of Education (Ced)", image: "img/osas.jpg", link: "http://example.com/osas" },
      "department of science and technology caraga region(dost)": { lat: 8.953213412910166,  lng: 125.5982116566809, info: "Department of Science and Technology Caraga Region(DOST)", image: "img/osas.jpg", link: "http://example.com/osas" },
  };

  try {
    if (useMyLocation) {
      // Get current location
      const currentLocation = await getCurrentLocation();
      startLocation = new google.maps.LatLng(currentLocation.lat, currentLocation.lng);
    } else if (searchLocations[startInput]) {
      // Use typed location if found in searchLocations
      const locationData = searchLocations[startInput];
      startLocation = new google.maps.LatLng(locationData.lat, locationData.lng);
    } else {
      alert('Start location not found!');
      return;
    }

    if (endMarkers.length === 0) {
      if (searchLocations[endInput]) {
        const locationData = searchLocations[endInput];
        const position = new google.maps.LatLng(locationData.lat, locationData.lng);

        const marker = new google.maps.Marker({
          position: position,
          map: map,
          icon: {
            url: "https://static.vecteezy.com/system/resources/previews/010/160/458/non_2x/pin-location-icon-sign-symbol-design-free-png.png",
            scaledSize: new google.maps.Size(22, 32),
          },
        });

        endMarkers = [{ marker, info: locationData.info }];
      } else {
        alert('End location not found!');
        return;
      }
    }

    if (endMarkers.length > 0) {
      if (endMarkers.length === 1) {
        const endMarker = endMarkers[0];

        const request = {
          origin: startLocation,
          destination: endMarker.marker.position,
          travelMode: 'WALKING',
        };

        directionsService.route(request, function (result, status) {
          if (status === 'OK') {
            directionsRenderer.setDirections(result);
          } else {
            alert('Directions request failed due to ' + status);
          }
        });
      } else {
        alert('Multiple end locations found.');
      }
    }
  } catch (error) {
    alert('Failed to get directions: ' + error.message);
  }
}

// old async function
async function initMap() {
  const { Map } = await google.maps.importLibrary("maps");
  const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

  map = new Map(document.getElementById("map"), {
    center: { lat: 8.957188363048896,  lng: 125.59694453261423  },
    zoom: 18,
    mapId: "DEMO_MAP_ID",
  });

  //adjust polyline
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);
  
  directionsRenderer.setOptions({
    polylineOptions: {
      strokeColor: 'Blue',
      strokeOpacity: 1,
      strokeWeight: 7
    }
  });

  const features = [
    {
      position: { lat: 8.959087604461281, lng: 125.59593194296626  },
      info: "CAA Canteen",
      image: "img/download.jpeg",
      link: "ccis.html",
    },
    {
      position: { lat: 8.959464451759239, lng: 125.59725271438047 },
      info: "CED Canteen",
      image: "img/download.jpeg",
      link: "ccis.html",
    },
    {
      position: { lat: 8.9578, lng: 125.5971 },
      info: "Batok Hall",
      image: "img/download.jpeg",
      link: "ccis.html",
    },
    {
      position: { lat: 8.9590, lng: 125.5957 },
      info: "College of Agriculture and Agri-Industries (CAA)",
      image: "img/download.jpeg",
      link: "caa.html"
    },
    {
      position: { lat: 8.9532, lng: 125.5972 },
      info: "CSU Main College of Forestry and Environmental Sciences",
      image: "img/csu.jpg",
    },
    {
      position: { lat: 8.955532271257468, lng: 125.59851599862621 },
      info: "Masawa hall",
      image: "img/csu.jpg",
    },
    {
      position: { lat: 8.9554, lng: 125.5978 },
      info: "College of Computing and Information Sciences",
      image: "img/ccis.jpg",
      link: "ccis.html"
    },
    {
      position: { lat: 8.949836599646707,  lng: 125.59798456212924 },
      info: "Carabaw Center",
      image: "img/csu.jpg",
    },
  ];

  for (const feature of features) {
    const customMarkerImg = document.createElement("img");
    customMarkerImg.src = "img/marker.png";
    customMarkerImg.style.width = "50px";
    customMarkerImg.style.height = "50px";

    const marker = new AdvancedMarkerElement({
      map,
      position: feature.position,
      content: customMarkerImg,
    });

    const infoWindowContent = `
      <div style="position: relative; text-align: center; width: 100%;">
        <h4>${feature.info}</h4>
        <a href="${feature.link || '#'}">
          <img src="${feature.image}" alt="${feature.info}" style="max-width: 200px; height: auto;">
        </a>
      </div>
    `;

    const infoWindow = new google.maps.InfoWindow({
      content: infoWindowContent,
    });

    infoWindows.push(infoWindow);
    markers.push({ marker, info: feature.info });

    marker.addListener("click", () => {
      infoWindows.forEach((iw) => iw.close());
      infoWindow.open(map, marker);
    });

    // Add event listener to open link in the same tab
    google.maps.event.addListener(infoWindow, 'domready', () => {
      const linkElement = document.querySelector(`a[href="${feature.link}"]`);
      if (linkElement) {
        linkElement.addEventListener("click", (event) => {
          event.preventDefault();
          window.location.href = feature.link;
        });
      }
    });
  }
}

//(old)
google.maps.event.addListener(marker, 'click', () => {
  infoWindow.open(map, marker);
  // When closing the info window, close the marker too
  google.maps.event.addListener(infoWindow, 'closeclick', () => {
    marker.setMap(null); // Remove marker when info window is closed
    dynamicMarkers = dynamicMarkers.filter(m => m !== marker); // Remove marker from array
  });
});


  // Add event listener to open link in the same tab (1)
  google.maps.event.addListener(infoWindow, 'domready', () => {
    const linkElement = document.querySelector(`a[href="${feature.link}"]`);
    if (linkElement) {
      linkElement.addEventListener("click", (event) => {
        event.preventDefault();
        window.location.href = feature.link;
      });
    }
  });

// Add event listener to open link in the same tab (2)
  google.maps.event.addListener(infoWindow, 'domready', () => {
    const linkElement = document.querySelector(`a[href="${locationData.link}"]`);
    if (linkElement) {
      linkElement.addEventListener("click", (event) => {
        event.preventDefault();
        window.location.href = locationData.link;
      });
    }
  });

// Add event listener to open link in the same tab (3)
  google.maps.event.addListener(infoWindow, 'domready', () => {
    const linkElement = document.querySelector(`a[href="${locationData.link}"]`);
    if (linkElement) {
      linkElement.addEventListener("click", (event) => {
        event.preventDefault();
        window.location.href = locationData.link; // Open in the same tab
      });
    }
  });


  google.maps.event.addListener(infoWindow, 'domready', () => {
    const linkElement = document.querySelector(`a[href="${feature.link}"]`);
    if (linkElement) {
      linkElement.addEventListener("click", (event) => {
        event.preventDefault();
        window.location.href = feature.link;
      });
    }
  });









//orig code
  let map;
let infoWindows = [];
let markers = [];
let directionsService;
let directionsRenderer;
let dynamicMarkers = []; // Array to store dynamically created markers


async function initMap() {
  const { Map } = await google.maps.importLibrary("maps");
  const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

  map = new Map(document.getElementById("map"), {
    center: { lat: 8.957188363048896,  lng: 125.59694453261423  },
    zoom: 17,
    mapId: "DEMO_MAP_ID",
  });

  //adjust polyline
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);
  
  directionsRenderer.setOptions({
    polylineOptions: {
      strokeColor: 'Blue',
      strokeOpacity: 1,
      strokeWeight: 7
    }
  });

  const features = [
    {
      position: { lat: 8.955575598052341, lng: 125.59664046282884, },
      info: "Old CAS",
      image: "img/oldcas.jpg",
      link: "oldcas.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.953213412910166,  lng: 125.5982116566809, },
      info: "Department of Science and Technology Caraga Region(DOST)",
      image: "img/dost.jpg",
      link: "dost.html",
      icon: "img/dpt.png", // Specific icon for this location
    },
    {
      position: { lat: 8.955977741789837,  lng: 125.59566640516326 },
      info: "CSU main Gymnasium and Cultural center",
      image: "img/gym.jpg",
      link: "gym.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.958486428920668,  lng: 125.5972223715645  },
      info: "NSB Canteen",
      image: "img/download.jpeg",
      link: "nsb-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.957376450320611, lng: 125.59566892198143  },
      info: "Boffo Food Hub Canteen",
      image: "img/download.jpeg",
      link: "bofo.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.953314087321177, lng: 125.59714493015973  },
      info: "COFES Canteen",
      image: "img/cofes.jpg",
      link: "cofes-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.955626166710692, lng: 125.59704251248058  },
      info: "CSU Personnel multipurpose cooperative canteen",
      image: "img/download.jpeg",
      link: "coo-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.959087604461281, lng: 125.59593194296626  },
      info: "CAA Canteen",
      image: "img/download.jpeg",
      link: "caa-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.959464451759239, lng: 125.59725271438047 },
      info: "CED Canteen",
      image: "img/download.jpeg",
      link: "ced-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.95786387399443,  lng: 125.59635007361663  },
      info: "CSU Main HERO Learning Commons",
      image: "img/library.jpg",
      link: "lib.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat:8.957890221298307,  lng: 125.5969669581597 },
      info: "New Science Building (NSB/Batok Hall)",
      image: "img/nsb.jpg",
      link: "nsb.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.9590, lng: 125.5957 },
      info: "College of Agriculture and Agri-Industries (CAA)",
      image: "img/download.jpeg",
      link: "caa.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.9532, lng: 125.5972 },
      info: "CSU Main College of Forestry and Environmental Sciences (COFES)",
      image: "img/cofes.jpg",
      icon: "img/college.png", // Specific icon for this location
      link: "cofes.html"
    },
    {
      position: { lat: 8.956091004584328, lng: 125.59792323787687 },
      info: "College of Humanities and Social Sciences/Kinaadman Hall",
      image: "img/kinaadman.jpg",
      icon: "img/college.png", // Specific icon for this location
      link: "chass.html"
    },
    {
      position: { lat: 8.955532271257468, lng: 125.59851599862621 },
      info: "Masawa hall",
      image: "img/csu.jpg",
      icon: "img/college.png", // Specific icon for this location
      link: "masawa.html"
    },
    {
      position: { lat: 8.9554, lng: 125.5978 },
      info: "College of Computing and Information Sciences (CCIS)",
      image: "img/ccis.jpg",
      link: "ccis.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.954970254233311,  lng: 125.59793373424142 },
      info: "College Engineering and Geosciences(CEGS)",
      image: "img/cegs.jpg",
      link: "cegs.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.959289352385552,   lng: 125.59702311903386, },
      info: "College of Education",
      image: "img/ccis.jpg",
      link: "ced.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.949836599646707,  lng: 125.59798456212924 },
      info: "Carabao Center",
      image: "img/csu.jpg",
      icon: "img/carabao.png", // Specific icon for this location
       link: "carabao.html",
    },
    {
      position: { lat: 8.957250380365862,  lng: 125.59764832350852 },
      info: "New Administraion Building",
      image: "img/admin.jpg",
      icon: "img/dpt.png", // Specific icon for this location
      link: "admin.html"
    },
    {
      position: { lat: 8.956825777829309,  lng: 125.59738154793322 },
      info: "Old Administraion Building",
      image: "img/oldadmin.jpg",
      link: "oldadmin.html",
      icon: "img/dpt.png", // Specific icon for this location
    },
    {
      position: { lat: 8.958930947394402, lng: 125.59506156797713, },
      info: "CAA Greenhouse ",
      image: "img/csu.jpg",
      link: "caa-greenhouse.html",
      icon: "img/plant.png", // Specific icon for this location
    },
    {
      position: { lat: 8.953670505991782,  lng: 125.5971810025196, },
      info: "Organic Agriculture Training Center",
      image: "img/oatc.jpg",
      link: "oatc.html",
      icon: "img/dpt.png", // Specific icon for this location
    },
    {
      position: { lat: 8.958735140337026,  lng: 125.59833326532635, },
      info: "Hostel building",
      image: "img/hostel.jpg",
      link: "hostel.html",
      icon: "img/college.png", // Specific icon for this location
      description: "This facility can be located in the Hostel Building." 
    },
    {
      position: { lat: 8.955562274721453, lng: 125.59594834589646, },
      info: "Sports Office",
      image: "img/sports.jpg",
      link: "sports.html",
      icon: "img/sports.png", // Specific icon for this location
    },
    {
      position: { lat: 8.956476963908328, lng: 125.59541117924815 },
      info: "Anex 3 Building",
      image: "img/anex.jpg",
      link: "anex1.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.957465490271211,  lng: 125.59814632842759 },
      info: "Farm Mechanization Center",
      image: "img/farmmech.jpg",
      link: "farmmech.html",
      icon: "img/dpt.png", // Specific icon for this location
    },
    {
      position: { lat: 8.954527524733473, lng:  125.59807198444454, },
      info: "Anex 2",
      image: "img/acadb.png",
      link: "farmmech.html",
      icon: "img/college.png", // Specific icon for this location
    },
  ];

  for (const feature of features) {
    const customMarkerImg = document.createElement("img");
    customMarkerImg.src = feature.icon || "img/default-marker.png"; // Use the location-specific icon or a default
    customMarkerImg.style.width = "45px";
    customMarkerImg.style.height = "45px";

    const marker = new AdvancedMarkerElement({
      map,
      position: feature.position,
      content: customMarkerImg,
    });

    const infoWindowContent = `
      <div style="width: 200px; text-align: center; overflow-wrap: break-word;">
        <a href="${feature.link || '#'}">
          <img src="${feature.image}" alt="${feature.info}" style="max-width: 200px; height: 100px; margin-bottom: 10px; border-radius: 10px;">
        </a>
        <h6>${feature.info}</h6>
        <p>${feature.description}</p>
      </div>
    `;

    const infoWindow = new google.maps.InfoWindow({
      content: infoWindowContent,
    });

    infoWindows.push(infoWindow);
    markers.push({ marker, info: feature.info });

    marker.addListener("click", () => {
      infoWindows.forEach((iw) => iw.close());
      infoWindow.open(map, marker);
    });

// Add event listener to open link in a new tab
google.maps.event.addListener(infoWindow, 'domready', () => {
  const linkElement = document.querySelector(`a[href="${feature.link}"]`);
  if (linkElement) {
    linkElement.addEventListener("click", (event) => {
      event.preventDefault();

      // Open link in a new tab
      const newTab = window.open(feature.link, "_blank");

      // Focus back to the original tab when the new tab is closed
      const checkTabClosed = setInterval(() => {
        if (newTab.closed) {
          clearInterval(checkTabClosed);
          window.focus();
        }
      }, 500);
    });
  }
});

  }
}



function searchLocation() {
  const searchInput = document.getElementById("search-input").value.trim().toLowerCase();
  const found = markers.filter(m => m.info.toLowerCase().includes(searchInput));

  if (found.length > 0) {
    if (found.length === 1) {
      const location = found[0];
      map.panTo(location.marker.position);
      map.setZoom(18);
      infoWindows.forEach((iw) => iw.close());
      google.maps.event.trigger(location.marker, 'click');
    } else {
      alert(`Multiple locations found: ${found.map(loc => loc.info).join(", ")}`);
    }
  } else {
    const searchLocations = { 
      "registrar": {  lat: 8.956943189494943, lng: 125.59745241416188, info: "Registrar", image: "img/registrar.jpg", link: "nsb-canteen.html",description: "This is the Registrar's office, where students can manage their academic records." },
    "oas": {  lat: 8.95689685581763, lng: 125.59717054069868, info: "OAS", image: "img/oas.jpg", link: "nsb-canteen.html", description: "This can be located at the Old administration building." },
      "food technology center": {  lat: 8.95885218261509,    lng: 125.59633765001367, info: "Food Technology Center", image: "img/canteen.jpg", link: "nsb-canteen.html" },
      "caraga food innovation center": {  lat: 8.958682057187627,   lng: 125.59588324874615, info: "Caraga Food Innovation Center", image: "img/canteen.jpg", link: "nsb-canteen.html" },
      "organic agriculture training center": {  lat: 8.953670505991782,  lng: 125.5971810025196, info: "Organic Agriculture Training Center", image: "img/oatc.jpg", link: "nsb-canteen.html" },
      "nsb canteen": {  lat: 8.958486428920668,  lng: 125.5972223715645, info: "NSB Canteen", image: "img/canteen.jpg", link: "nsb-canteen.html" },
      "new science building (nsb/batok hall)": {  lat:8.957890221298307,  lng: 125.5969669581597, info: "New Science building (NSB/Batok Hall)", image: "img/nsb.jpg", link: "nsb.html" },
      "csu main college of forestry and environmental sciences (cofes)": { lat: 8.9532, lng: 125.5972, info: "CSU Main College of Forestry and Environmental Sciences (COFES)", image: "img/cofes.jpg", link: "cofes.html" },  
      "farm mechanization center": { lat: 8.957465490271211,  lng: 125.59814632842759, info: "Farm Mechanization Center", image: "img/farmmech.jpg", link: "farmmech.html" },
      "college of humanities and social sciences/kinaadman hall": { lat: 8.956091004584328, lng: 125.59792323787687, info: "College of Humanities and Social Sciences/Kinaadman Hall", image: "img/kinaadman.jpg", link: "chass.html" },
      "new administration building": { lat: 8.957250380365862,  lng: 125.59764832350852, info: "New Administration Building", image: "img/admin.jpg", link: "admin.html" },
      "old administration building": { lat: 8.956825777829309,  lng: 125.59738154793322, info: "Old Administration Building", image: "img/oldadmin.jpg", link: "oldadmin.html" },
      "anex 2": { lat: 8.954527524733473, lng:  125.59807198444454, info: "Anex 2", image: "img/anex.jpg", link: "http://example.com/anex" },
      "anex 3 building": { lat: 8.956476963908328, lng: 125.59541117924815, info: "Anex 3 Building", image: "img/anex.jpg", link: "anex1.html" }, 
      "villares": { lat: 8.953157960469824,  lng: 125.59738112140803, info: "CSU Villares Building", image: "img/canteen.jpg", link: "" },   
      "csu main hero learning commons": { lat: 8.95786387399443,  lng: 125.59635007361663, info: "CSU Main HERO Learning Commons", image: "img/library.jpg", link: "lib.html" },
      "old cas building": { lat: 8.955575598052341, lng: 125.59664046282884, info: "Old CAS Building", image: "img/oldcas.jpg", link: "oldcas.html" },
      "college of computing and information sciences (ccis)": { lat: 8.9554, lng: 125.5978, info: "College of Computing and Information Sciences (CCIS)", image: "img/ccis.jpg", link: "ccis.html" },
      "field": { lat: 8.956543619178424,  lng: 125.59649493048896, info: "Field", image: "img/oval.jpg", link: "field.html" },
      "boffo food hub canteen": { lat: 8.957376450320611, lng: 125.59566892198143, info: "Boffo Food Hub Canteen", image: "img/canteen.jpg", link: "bofo.html" },
      "anex": { lat: 8.956526045261818, lng: 125.59551789945878, info: "Anex", image: "img/anex.jpg", link: "http://example.com/anex" },
      "osas": { lat: 8.956938598181836, lng: 125.5974861856326, info: "Osas", image: "img/osas.jpg", link: "http://example.com/osas" },
      "eco hall": { lat: 8.955018346783993, lng: 125.5969820861699, info: "Eco Hall", image: "img/ecohall.jpg", link: "http://example.com/osas" },
      "sports office": { lat: 8.955562274721453, lng: 125.59594834589646, info: "Sports Office", image: "img/sports.jpg", link: "sports.html" },
      "csu main gymnasium and cultural center": { lat: 8.955977741789837,  lng: 125.59566640516326, info: "CSU Main Gymnasium and Cultural Center", image: "img/img/gym.jpg", link: "gym.html" },
      "college of education (ced)": { lat: 8.959289352385552,   lng: 125.59702311903386, info: "College of Education (Ced)", image: "img/osas.jpg", link: "ced.html" },
      "ced canteen": { lat: 8.959464451759239, lng: 125.59725271438047, info: "CED Canteen", image: "img/osas.jpg", link: "ced-canteen.html" },
      "caa canteen": { lat: 8.959087604461281, lng: 125.59593194296626, info: "CAA Canteen", image: "img/osas.jpg", link: "caa-canteen.html" },
      "cofes canteen": { lat: 8.953314087321177, lng: 125.59714493015973, info: "COFES Canteen", image: "img/osas.jpg", link: "cofes-canteen.html" },
      "department of science and technology caraga region(dost)": { lat: 8.953213412910166,  lng: 125.5982116566809, info: "Department of Science and Technology Caraga Region(DOST)", image: "img/dost.jpg", link: "dost.html" },
      "college of engineering and geosciences(cegs)": { lat: 8.954970254233311,  lng: 125.59793373424142, info: "College Engineering and Geosciences(CEGS)", image: "img/cegs.jpg", link: "cegs.html" },
      "masawa hall": { lat: 8.955532271257468, lng: 125.59851599862621, info: "Masawa Hall", image: "img/osas.jpg", link: "masawa.html" },
      "college of agriculture and agri-industries (caa)": { lat: 8.9590, lng: 125.5957, info: "College of Agriculture and Agri-Industries (CAA)", image: "", link: "caa.html" },
      "caa greenhouse": { lat: 8.958930947394402, lng: 125.59506156797713, info: "CAA Greenhouse", image: "", link: "caa-greenhouse.html" },
      "hostel building": { lat: 8.958735140337026,  lng: 125.59833326532635, info: "Hostel Building", image: "img/hostel.jpg", link: "hostel.html" },
      "csu personnel multipurpose cooperative canteen": { lat: 8.955626166710692, lng: 125.59704251248058, info: "CSU Personnel multipurpose cooperative canteen", image: "", link: "coo-canteen.html" },
      "clinic": { lat: 8.95865014355704,  lng: 125.59801501452652, info: "Clinic", image: "img/clinic.jpg", link: "hostel.html" },
    };

    const matchedLocations = Object.keys(searchLocations).filter(key => key.includes(searchInput));
    if (matchedLocations.length > 0) {
      if (matchedLocations.length === 1) {
        const locationData = searchLocations[matchedLocations[0]];
        const position = new google.maps.LatLng(locationData.lat, locationData.lng);
//customize dynamic marker
        const marker = new google.maps.Marker({
          position: position,
          map: map,
          icon: {
            url: "img/dynamic.png", // URL to your custom marker icon
            scaledSize: new google.maps.Size(45, 45), // Custom size
          },
        });

        const infoWindowContent = `
          <div style="width: 200px; text-align: center; overflow-wrap: break-word;">
            <a href="${locationData.link}">
              <img src="${locationData.image}" alt="${locationData.info}" style="max-width: 200px; height: 100px; margin-bottom: 10px; border-radius: 10px;">
            </a>
            <h6>${locationData.info}</h6>
             <p>${locationData.description}</p>
          </div>
        `;
        const infoWindow = new google.maps.InfoWindow({
          content: infoWindowContent,
        });

        infoWindows.forEach((iw) => iw.close());
        infoWindow.open(map, marker);
        map.panTo(position);
        map.setZoom(18);

        google.maps.event.addListener(infoWindow, 'closeclick', function () {
          marker.setMap(null);
        });

        marker.addListener("click", () => {
          infoWindow.open(map, marker);
        });

        // Add event listener to open link in new tab
      google.maps.event.addListener(infoWindow, 'domready', () => {
  const linkElement = document.querySelector(`a[href="${locationData.link}"]`);
  if (linkElement) {
    linkElement.addEventListener("click", (event) => {
      event.preventDefault();

      // Open link in a new tab
      const newTab = window.open(locationData.link, "_blank");

      // Focus back to the original tab when the new tab is closed
      if (newTab) {
        const checkTabClosed = setInterval(() => {
          if (newTab.closed) {
            clearInterval(checkTabClosed);
            window.focus();
          }
        }, 500);
      }
    });
  }
});

      } else {
        alert(`Multiple locations found: ${matchedLocations.map(loc => searchLocations[loc].info).join(", ")}`);
      }
    } else {
      alert('Location not found!');
    }
  }
}

// Modified getDirections function
async function getDirections() {
  const startInput = document.getElementById("start-input").value.trim().toLowerCase();
  const useMyLocation = document.getElementById("use-my-location").checked;
  const endInput = document.getElementById("end-input").value.trim().toLowerCase();

  let startLocation;
  const searchLocations = {
    // Predefined locations here ...
    "registrar": {  lat: 8.956943189494943, lng: 125.59745241416188, info: "Registrar", image: "img/registrar.jpg", link: "nsb-canteen.html" },
    "oas": {  lat: 8.95689685581763, lng: 125.59717054069868, info: "OAS", image: "img/oas.jpg", link: "nsb-canteen.html" },
    "food technology center": {  lat: 8.95885218261509,    lng: 125.59633765001367, info: "Food Technology Center", image: "img/canteen.jpg", link: "nsb-canteen.html" },
    "caraga food innovation center": {  lat: 8.958682057187627,   lng: 125.59588324874615, info: "Caraga Food Innovation Center", image: "img/canteen.jpg", link: "nsb-canteen.html" },
    "organic agriculture training center": {  lat: 8.953670505991782,  lng: 125.5971810025196, info: "Organic Agriculture Training Center", image: "img/oatc.jpg", link: "nsb-canteen.html" },
    "nsb canteen": {  lat: 8.958486428920668,  lng: 125.5972223715645, info: "NSB Canteen", image: "img/canteen.jpg", link: "nsb.html" },
    "cofes canteen": { lat: 8.953314087321177, lng: 125.59714493015973, info: "COFES Canteen", image: "img/osas.jpg", link: "cofes-canteen.html" },
    "new science building (nsb/batok hall)": {  lat:8.957890221298307,  lng: 125.5969669581597, info: "New Science building (NSB/Batok Hall)", image: "img/nsb.jpg", link: "nsb.html" },
    "csu main college of forestry and environmental sciences (cofes)": { lat: 8.9532, lng: 125.5972, info: "CSU Main College of Forestry and Environmental Sciences (COFES)", image: "img/cofes.jpg", link: "cofes.html" },
    "farm mechanization center": { lat: 8.957465490271211,  lng: 125.59814632842759, info: "Farm Mechanization Center", image: "img/farmmech.jpg", link: "farmmech.html" },
    "college of humanities and social sciences/kinaadman hall": { lat: 8.956091004584328, lng: 125.59792323787687, info: "College of Humanities and Social Sciences/Kinaadman Hall", image: "img/kinaadman.jpg", link: "chass.html" },
    "old administration building": { lat: 8.956825777829309,  lng: 125.59738154793322, info: "Old Administration Building", image: "img/oldadmin.jpg", link: "oldadmin.html" },
    "new administration building": { lat: 8.957250380365862,  lng: 125.59764832350852,  info: "New Administration Building", image: "img/admin.jpg", link: "admin.html" },
      "anex 2": { lat: 8.954527524733473, lng:  125.59807198444454, info: "Anex 2", image: "img/anex.jpg", link: "http://example.com/anex" },  
      "anex 3 building": { lat: 8.956476963908328, lng: 125.59541117924815, info: "Anex 3 Building", image: "img/anex.jpg", link: "anex1.html" },  
      "villares": { lat: 8.953157960469824,  lng: 125.59738112140803,  info: "CSU Villares Building", image: "img/canteen.jpg", link: "cofes.html" }, 
      "csu main hero learning commons": { lat: 8.95786387399443,  lng: 125.59635007361663, info: "CSU Main HERO Learning Commons", image: "img/library.jpg", link: "lib.html" },
      "old cas building": { lat: 8.955575598052341, lng: 125.59664046282884, info: "Old CAS Building", image: "img/oldcas.jpg", link: "oldcas.html" },
      "college of computing and information sciences (ccis)": { lat: 8.9554, lng: 125.5978, info: "College of Computing and Information Sciences (CCIS)", image: "img/ccis.jpg", link: "ccis.html" },
      "field": { lat: 8.956543619178424,  lng: 125.59649493048896, info: "Field", image: "img/oval.jpg", link: "field.html" },
      "boffo food hub canteen": { lat: 8.957376450320611, lng: 125.59566892198143, info: "Boffo Food Hub Canteen", image: "img/canteen.jpg", link: "bofo.html" },
      "anex": { lat: 8.956526045261818, lng: 125.59551789945878, info: "Anex", image: "img/anex.jpg", link: "http://example.com/anex" },
      "osas": { lat: 8.956938598181836, lng: 125.5974861856326, info: "Osas", image: "img/osas.jpg", link: "http://example.com/osas" },
      "eco hall": { lat: 8.955018346783993, lng: 125.5969820861699, info: "Eco Hall", image: "img/ecohall.jpg", link: "http://example.com/osas" },
      "sports office": { lat: 8.955562274721453, lng: 125.59594834589646, info: "Sports Office", image: "img/sports.jpg", link: "sports.html" },
      "csu main gymnasium and cultural center": { lat: 8.955977741789837,  lng: 125.59566640516326, info: "CSU Main Gymnasium and Cultural Center", image: "img/img/gym.jpg", link: "gym.html" },
      "college of education (ced)": { lat: 8.959289352385552,   lng: 125.59702311903386, info: "College of Education (Ced)", image: "img/osas.jpg", link: "ced.html" },
      "ced canteen": { lat: 8.959464451759239, lng: 125.59725271438047, info: "CED Canteen", image: "img/osas.jpg", link: "ced-canteen.html" },
      "caa canteen": { lat: 8.959087604461281, lng: 125.59593194296626, info: "CAA Canteen", image: "img/osas.jpg", link: "caa-canteen.html" },
      "department of science and technology caraga region(dost)": { lat: 8.953213412910166,  lng: 125.5982116566809, info: "Department of Science and Technology Caraga Region(DOST)", image: "img/dost.jpg", link: "http://example.com/osas" },
      "college of engineering and geosciences(cegs)": { lat: 8.954970254233311,  lng: 125.59793373424142, info: "College Engineering and Geosciences(CEGS)", image: "img/cegs.jpg", link: "cegs.html" },
      "masawa hall": { lat: 8.955532271257468, lng: 125.59851599862621, info: "Masawa Hall", image: "img/osas.jpg", link: "masawa.html" },
      "college of agriculture and agri-industries (caa)": { lat: 8.9590, lng: 125.5957, info: "College of Agriculture and Agri-Industries (CAA)", image: "", link: "caa.html" },
      "caa greenhouse": { lat: 8.958930947394402, lng: 125.59506156797713, info: "CAA Greenhouse", image: "", link: "caa.html" },
      "hostel building": { lat: 8.958735140337026,  lng: 125.59833326532635, info: "Hostel Building", image: "img/hostel.jpg", link: "hostel.html" },
      "clinic": { lat: 8.95865014355704,  lng: 125.59801501452652, info: "Clinic", image: "img/clinic.jpg", link: "hostel.html" },
      "csu personnel multipurpose cooperative canteen": { lat: 8.955626166710692, lng: 125.59704251248058, info: "CSU Personnel multipurpose cooperative canteen", image: "", link: "coo-canteen.html" },
  };

  try {
    // Determine start location
    if (useMyLocation) {
      const currentLocation = await getCurrentLocation();
      startLocation = new google.maps.LatLng(currentLocation.lat, currentLocation.lng);
    } else if (searchLocations[startInput]) {
      const locationData = searchLocations[startInput];
      startLocation = new google.maps.LatLng(locationData.lat, locationData.lng);
    } else {
      alert('Start location not found!');
      return;
    }

    // Remove existing dynamic markers from the map
    dynamicMarkers.forEach(marker => marker.setMap(null));
    dynamicMarkers = []; // Clear the array

    // Create a new dynamic marker for start location
    if (searchLocations[startInput]) {
      const locationData = searchLocations[startInput];
      const position = new google.maps.LatLng(locationData.lat, locationData.lng);
      const marker = new google.maps.Marker({
        position: position,
        map: map,
        icon: {
          url: "img/dynamic.png",
          scaledSize: new google.maps.Size(45, 45),
        },
      });

      // Add InfoWindow for start location
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="width: 200px; text-align: center; overflow-wrap: break-word;">
            <a href="${locationData.link}" target="_blank">
              <img src="${locationData.image}" alt="${locationData.info}" style="width: 200px; height: 100px; margin-bottom: 10px; border-radius: 10px;">
            </a>
            <h6>${locationData.info}</h6>
            <p>${locationData.description}</p>
          </div>
        `,
      });

      
        infoWindow.open(map, marker);
        // When closing the info window, close the marker too
        google.maps.event.addListener(infoWindow, 'closeclick', () => {
          marker.setMap(null); // Remove marker when info window is closed
          dynamicMarkers = dynamicMarkers.filter(m => m !== marker); // Remove marker from array
        });
      

      dynamicMarkers.push(marker); // Add to dynamicMarkers array
    }

    // Create a new dynamic marker for end location
    if (searchLocations[endInput]) {
      const locationData = searchLocations[endInput];
      const position = new google.maps.LatLng(locationData.lat, locationData.lng);
      const marker = new google.maps.Marker({
        position: position,
        map: map,
        icon: {
          url: "img/dynamic.png",
          scaledSize: new google.maps.Size(45, 45),
        },
      });

      // Add InfoWindow for end location
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="width: 200px; text-align: center; overflow-wrap: break-word;">
            <a href="${locationData.link}" target="_blank">
              <img src="${locationData.image}" alt="${locationData.info}" style="width: 200px; height: 100px; margin-bottom: 10px; border-radius: 10px;">
            </a>
            <h6>${locationData.info}</h6>
            <p>${locationData.description}</p>
          </div>
        `,
      });

      
        infoWindow.open(map, marker);
        // When closing the info window, close the marker too
        google.maps.event.addListener(infoWindow, 'closeclick', () => {
          marker.setMap(null); // Remove marker when info window is closed
          dynamicMarkers = dynamicMarkers.filter(m => m !== marker); // Remove marker from array
        });

         // Add event listener to open link in new tab
         google.maps.event.addListener(infoWindow, 'domready', () => {
          const linkElement = document.querySelector(`a[href="${locationData.link}"]`);
          if (linkElement) {
            linkElement.addEventListener("click", (event) => {
              event.preventDefault();
        
              // Open the link in a new tab
              const newTab = window.open(locationData.link, "_blank");
        
              // If the new tab was opened successfully, check when it's closed
              if (newTab) {
                const checkTabClosed = setInterval(() => {
                  if (newTab.closed) {
                    clearInterval(checkTabClosed);
                    window.focus(); // Bring focus back to the original tab
                  }
                }, 500);
              }
            });
          }
        });
        
      

      dynamicMarkers.push(marker); // Add to dynamicMarkers array
    } else {
      alert('End location not found!');
      return;
    }

    // Get directions if dynamic markers exist
    if (dynamicMarkers.length > 0) {
      const endMarker = dynamicMarkers[dynamicMarkers.length - 1]; // Use the last dynamic marker for directions

      const request = {
        origin: startLocation,
        destination: endMarker.getPosition(),
        travelMode: 'WALKING',
      };

      directionsService.route(request, function (result, status) {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
        } else {
          alert('Directions request failed due to ' + status);
        }
      });
    }
  } catch (error) {
    alert('Failed to get directions: ' + error.message);
  }
}

navigator.geolocation.getCurrentPosition(function (position) {
  const userLocation = {
    lat: position.coords.latitude,
    lng: position.coords.longitude
  };

  // Add a marker for the user's location with a custom icon
  new google.maps.Marker({
    position: userLocation,
    map: map,
    title: "You are here",
    icon: {
      url: "img/user.png", // Replace this with the path to your custom marker icon
      scaledSize: new google.maps.Size(50, 50), // Optional: Adjust the size of the icon
    },
  });
});

// Function to get user's current location
function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          resolve({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        },
        (error) => {
          reject(error);
        }
      );
    } else {
      reject(new Error('Geolocation is not supported by this browser.'));
    }
  });
}

//Auto complete locations
const inputFields = ["search-input", "start-input", "end-input"]; // IDs of the input fields
const predefinedLocations = [
  { name: "New Administration Building" },
  { name: "College of Education (Ced)" },
  { name: "CSU Main HERO Learning Commons"},
  { name: "Old CAS building" },
  { name: "college of computing and information sciences (CCIS)" },
  { name: "Department of Science and Technology Caraga Region(DOST)" },
  { name: "OSAS" },
  { name: "Clinic" },
  { name: "Eco Hall"},
  { name: "Masawa Hall"},
  { name: "CSU Main Gymnasium and Cultural Center" },
  { name: "College of Engineering and Geosciences(CEGS)" },
  { name: "College of Agriculture and Agri-Industries (CAA)" },
  { name: "Field"},
  { name: "CED Canteen"},
  { name: "CAA Canteen"},
  { name: "CAA Greenhouse"},
  { name: "College of Humanities and Social Sciences/Kinaadman Hall"},
  { name: "Farm Mechanization Center"},
  { name: "Boffo Food Hub Canteen"},
  { name: "Hostel Building"},
  { name: "Old Administration Building"},
  { name: "CSU Personnel multipurpose cooperative canteen"},
  { name: "CSU Main College of Forestry and Environmental Sciences (COFES)"},
  { name: "New Science Building (NSB/Batok Hall)"},
  { name: "Sports Office"},
  { name: "Anex 3 Building"},
  { name: "NSB Canteen"},
  { name: "COFES Canteen"},
  { name: "Organic Agriculture Training Center"},
  { name: "Caraga Food Innovation Center"},
  { name: "Food Technology Center"},
  { name: "Registrar"},
  { name: "OAS"},
];

// Function to apply autocomplete functionality to an input field
function applyAutocomplete(inputId) {
    const inputField = document.getElementById(inputId);
    const dropdown = document.createElement("div");
    dropdown.classList.add("autocomplete-dropdown");
    inputField.parentNode.appendChild(dropdown);

    function updateDropdown() {
        const value = inputField.value.toLowerCase();
        dropdown.innerHTML = ""; // Clear previous suggestions

        // Filter locations based on input value
        const matchedLocations = predefinedLocations
            .filter(location => location.name.toLowerCase().includes(value))
            .slice(0, 5); // Limit to 5 results

        matchedLocations.forEach(location => {
            const item = document.createElement("div");
            item.classList.add("autocomplete-dropdown-item");
            item.textContent = location.name;

            // Using mousedown to capture touchpad and touchscreen events
            item.addEventListener("mousedown", () => {
                inputField.value = location.name;
                dropdown.innerHTML = ""; // Hide dropdown after selection
                // Additional functionality like placing marker on map can be added here
            });

            // Supporting touch devices with touchstart event
            item.addEventListener("touchstart", () => {
                inputField.value = location.name;
                dropdown.innerHTML = ""; // Hide dropdown after selection
            });

            dropdown.appendChild(item);
        });

        // Show dropdown if there are matches, hide it otherwise
        dropdown.style.display = matchedLocations.length ? "block" : "none";
    }

    inputField.addEventListener("input", updateDropdown);

    inputField.addEventListener("blur", () => {
        setTimeout(() => dropdown.style.display = "none", 150); // Delay to allow click
    });

    inputField.addEventListener("focus", updateDropdown);
}
// Apply autocomplete to each input field
inputFields.forEach(applyAutocomplete);

document.getElementById("search-button").addEventListener("click", searchLocation);
document.getElementById("directions-button").addEventListener("click", getDirections);
document.getElementById("clear-directions-button").addEventListener("click", clearDirections);

function clearDirections() {
  directionsRenderer.setDirections({ routes: [] });
  map.setCenter({ lat: 8.957188363048896,  lng: 125.59694453261423  }); // Center back to default
  map.setZoom(17); // Reset zoom if needed
}

initMap();



let map;
let infoWindows = [];
let markers = [];
let directionsService;
let directionsRenderer;
let dynamicMarkers = []; // Array to store dynamically created markers


async function initMap() {
  const { Map } = await google.maps.importLibrary("maps");
  const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

  map = new Map(document.getElementById("map"), {
    center: { lat: 8.957188363048896,  lng: 125.59694453261423  },
    zoom: 17,
    mapId: "DEMO_MAP_ID",
  });

  //adjust polyline
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);
  
  directionsRenderer.setOptions({
    polylineOptions: {
      strokeColor: 'Blue',
      strokeOpacity: 1,
      strokeWeight: 7
    }
  });

  const features = [
    {
      position: { lat: 8.955575598052341, lng: 125.59664046282884, },
      info: "Old CAS",
      image: "img/oldcas.jpg",
      link: "oldcas.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.953213412910166,  lng: 125.5982116566809, },
      info: "Department of Science and Technology Caraga Region(DOST)",
      image: "img/dost.jpg",
      link: "dost.html",
      icon: "img/dpt.png", // Specific icon for this location
    },
    {
      position: { lat: 8.955977741789837,  lng: 125.59566640516326 },
      info: "CSU main Gymnasium and Cultural center",
      image: "img/gym.jpg",
      link: "gym.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.958486428920668,  lng: 125.5972223715645  },
      info: "NSB Canteen",
      image: "img/download.jpeg",
      link: "nsb-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.957376450320611, lng: 125.59566892198143  },
      info: "Boffo Food Hub Canteen",
      image: "img/download.jpeg",
      link: "bofo.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.953314087321177, lng: 125.59714493015973  },
      info: "COFES Canteen",
      image: "img/cofes.jpg",
      link: "cofes-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.955626166710692, lng: 125.59704251248058  },
      info: "CSU Personnel multipurpose cooperative canteen",
      image: "img/download.jpeg",
      link: "coo-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.959087604461281, lng: 125.59593194296626  },
      info: "CAA Canteen",
      image: "img/caacanteen.jpg",
      link: "caa-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.959464451759239, lng: 125.59725271438047 },
      info: "CED Canteen",
      image: "img/cedcanteen.jpg",
      link: "ced-canteen.html",
      icon: "img/canteen.png", // Specific icon for this location
    },
    {
      position: { lat: 8.95786387399443,  lng: 125.59635007361663  },
      info: "CSU Main HERO Learning Commons",
      image: "img/library.jpg",
      link: "lib.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat:8.957890221298307,  lng: 125.5969669581597 },
      info: "New Science Building (NSB/Batok Hall)",
      image: "img/nsb.jpg",
      link: "nsb.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.9590, lng: 125.5957 },
      info: "College of Agriculture and Agri-Industries (CAA)",
      image: "img/caa.jpg",
      link: "caa.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.9532, lng: 125.5972 },
      info: "CSU Main College of Forestry and Environmental Sciences (COFES)",
      image: "img/cofes.jpg",
      icon: "img/college.png", // Specific icon for this location
      link: "cofes.html"
    },
    {
      position: { lat: 8.956091004584328, lng: 125.59792323787687 },
      info: "College of Humanities and Social Sciences/Kinaadman Hall",
      image: "img/kinaadman.jpg",
      icon: "img/college.png", // Specific icon for this location
      link: "chass.html"
    },
    {
      position: { lat: 8.955532271257468, lng: 125.59851599862621 },
      info: "Masawa hall",
      image: "img/masawa.jpg",
      icon: "img/college.png", // Specific icon for this location
      link: "masawa.html"
    },
    {
      position: { lat: 8.9554, lng: 125.5978 },
      info: "College of Computing and Information Sciences (CCIS)",
      image: "img/ccis.jpg",
      link: "ccis.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.954970254233311,  lng: 125.59793373424142 },
      info: "College Engineering and Geosciences(CEGS)",
      image: "img/cegs.jpg",
      link: "cegs.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.959289352385552,   lng: 125.59702311903386, },
      info: "College of Education",
      image: "img/ced.jpg",
      link: "ced.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.949836599646707,  lng: 125.59798456212924 },
      info: "Carabao Center",
      image: "img/csu.jpg",
      icon: "img/carabao.png", // Specific icon for this location
       link: "carabao.html",
    },
    {
      position: { lat: 8.957250380365862,  lng: 125.59764832350852 },
      info: "New Administraion Building",
      image: "img/admin.jpg",
      icon: "img/dpt.png", // Specific icon for this location
      link: "admin.html"
    },
    {
      position: { lat: 8.956825777829309,  lng: 125.59738154793322 },
      info: "Old Administraion Building",
      image: "img/oldadmin.jpg",
      link: "oldadmin.html",
      icon: "img/dpt.png", // Specific icon for this location
    },
    {
      position: { lat: 8.958930947394402, lng: 125.59506156797713, },
      info: "CAA Greenhouse ",
      image: "img/greenhouse.jpg",
      link: "caa-greenhouse.html",
      icon: "img/plant.png", // Specific icon for this location
    },
    {
      position: { lat: 8.953670505991782,  lng: 125.5971810025196, },
      info: "Organic Agriculture Training Center",
      image: "img/oatc.jpg",
      link: "oatc.html",
      icon: "img/dpt.png", // Specific icon for this location
    },
    {
      position: { lat: 8.958735140337026,  lng: 125.59833326532635, },
      info: "Hostel building",
      image: "img/hostel.jpg",
      link: "hostel.html",
      icon: "img/college.png", // Specific icon for this location
      description: "This facility can be located in the Hostel Building." 
    },
    {
      position: { lat: 8.955562274721453, lng: 125.59594834589646, },
      info: "Sports Office",
      image: "img/sports.jpg",
      link: "sports.html",
      icon: "img/sports.png", // Specific icon for this location
    },
    {
      position: { lat: 8.956476963908328, lng: 125.59541117924815 },
      info: "Anex 3 Building",
      image: "img/anex.jpg",
      link: "anex1.html",
      icon: "img/college.png", // Specific icon for this location
    },
    {
      position: { lat: 8.957465490271211,  lng: 125.59814632842759 },
      info: "Farm Mechanization Center",
      image: "img/farmmech.jpg",
      link: "farmmech.html",
      icon: "img/dpt.png", // Specific icon for this location
    },
    {
      position: { lat: 8.954527524733473, lng:  125.59807198444454, },
      info: "Anex 2",
      image: "img/acadb.png",
      link: "farmmech.html",
      icon: "img/college.png", // Specific icon for this location
    },
  ];

  for (const feature of features) {
    const customMarkerImg = document.createElement("img");
    customMarkerImg.src = feature.icon || "img/default-marker.png"; // Use the location-specific icon or a default
    customMarkerImg.style.width = "45px";
    customMarkerImg.style.height = "45px";

    const marker = new AdvancedMarkerElement({
      map,
      position: feature.position,
      content: customMarkerImg,
    });

    const infoWindowContent = `
      <div style="width: 200px; text-align: center; overflow-wrap: break-word;">
        <a href="${feature.link || '#'}">
          <img src="${feature.image}" alt="${feature.info}" style="max-width: 200px; height: 100px; margin-bottom: 10px; border-radius: 10px;">
        </a>
        <h6>${feature.info}</h6>
        <p>${feature.description}</p>
      </div>
    `;

    const infoWindow = new google.maps.InfoWindow({
      content: infoWindowContent,
    });

    infoWindows.push(infoWindow);
    markers.push({ marker, info: feature.info });

    marker.addListener("click", () => {
      infoWindows.forEach((iw) => iw.close());
      infoWindow.open(map, marker);
    });

// Add event listener to open link in a new tab
google.maps.event.addListener(infoWindow, 'domready', () => {
  const linkElement = document.querySelector(`a[href="${feature.link}"]`);
  if (linkElement) {
    linkElement.addEventListener("click", (event) => {
      event.preventDefault();

      // Open link in a new tab
      const newTab = window.open(feature.link, "_blank");

      // Focus back to the original tab when the new tab is closed
      const checkTabClosed = setInterval(() => {
        if (newTab.closed) {
          clearInterval(checkTabClosed);
          window.focus();
        }
      }, 500);
    });
  }
});

  }
}



function searchLocation() {
  const searchInput = document.getElementById("search-input").value.trim().toLowerCase();
  const found = markers.filter(m => m.info.toLowerCase().includes(searchInput));

  if (found.length > 0) {
    if (found.length === 1) {
      const location = found[0];
      map.panTo(location.marker.position);
      map.setZoom(18);
      infoWindows.forEach((iw) => iw.close());
      google.maps.event.trigger(location.marker, 'click');
    } else {
      alert(`Multiple locations found: ${found.map(loc => loc.info).join(", ")}`);
    }
  } else {
    const searchLocations = { 
      "registrar": {  lat: 8.956943189494943, lng: 125.59745241416188, info: "Registrar", image: "img/registrar.jpg", link: "nsb-canteen.html",description: "This is the Registrar's office, where students can manage their academic records." },
    "oas": {  lat: 8.95689685581763, lng: 125.59717054069868, info: "OAS", image: "img/oas.jpg", link: "nsb-canteen.html", description: "Office of admission and scholarship" },
      "food technology center": {  lat: 8.95885218261509,    lng: 125.59633765001367, info: "Food Technology Center", image: "img/canteen.jpg", link: "nsb-canteen.html" },
      "caraga food innovation center": {  lat: 8.958682057187627,   lng: 125.59588324874615, info: "Caraga Food Innovation Center", image: "img/canteen.jpg", link: "nsb-canteen.html" },
      "organic agriculture training center": {  lat: 8.953670505991782,  lng: 125.5971810025196, info: "Organic Agriculture Training Center", image: "img/oatc.jpg", link: "nsb-canteen.html" },
      "nsb canteen": {  lat: 8.958486428920668,  lng: 125.5972223715645, info: "NSB Canteen", image: "img/canteen.jpg", link: "nsb-canteen.html" },
      "new science building (nsb/batok hall)": {  lat:8.957890221298307,  lng: 125.5969669581597, info: "New Science building (NSB/Batok Hall)", image: "img/nsb.jpg", link: "nsb.html" },
      "csu main college of forestry and environmental sciences (cofes)": { lat: 8.9532, lng: 125.5972, info: "CSU Main College of Forestry and Environmental Sciences (COFES)", image: "img/cofes.jpg", link: "cofes.html" },  
      "farm mechanization center": { lat: 8.957465490271211,  lng: 125.59814632842759, info: "Farm Mechanization Center", image: "img/farmmech.jpg", link: "farmmech.html" },
      "college of humanities and social sciences/kinaadman hall": { lat: 8.956091004584328, lng: 125.59792323787687, info: "College of Humanities and Social Sciences/Kinaadman Hall", image: "img/kinaadman.jpg", link: "chass.html" },
      "new administration building": { lat: 8.957250380365862,  lng: 125.59764832350852, info: "New Administration Building", image: "img/admin.jpg", link: "admin.html" },
      "old administration building": { lat: 8.956825777829309,  lng: 125.59738154793322, info: "Old Administration Building", image: "img/oldadmin.jpg", link: "oldadmin.html" },
      "anex 2": { lat: 8.954527524733473, lng:  125.59807198444454, info: "Anex 2", image: "img/anex.jpg", link: "http://example.com/anex" },
      "anex 3 building": { lat: 8.956476963908328, lng: 125.59541117924815, info: "Anex 3 Building", image: "img/anex.jpg", link: "anex1.html" }, 
      "villares": { lat: 8.953157960469824,  lng: 125.59738112140803, info: "CSU Villares Building", image: "img/cofes.jpg", link: "" },   
      "csu main hero learning commons": { lat: 8.95786387399443,  lng: 125.59635007361663, info: "CSU Main HERO Learning Commons", image: "img/library.jpg", link: "lib.html" },
      "old cas building": { lat: 8.955575598052341, lng: 125.59664046282884, info: "Old CAS Building", image: "img/oldcas.jpg", link: "oldcas.html" },
      "college of computing and information sciences (ccis)": { lat: 8.9554, lng: 125.5978, info: "College of Computing and Information Sciences (CCIS)", image: "img/ccis.jpg", link: "ccis.html" },
      "field": { lat: 8.956543619178424,  lng: 125.59649493048896, info: "Field", image: "img/oval.jpg", link: "field.html" },
      "boffo food hub canteen": { lat: 8.957376450320611, lng: 125.59566892198143, info: "Boffo Food Hub Canteen", image: "img/canteen.jpg", link: "bofo.html" },
      "anex": { lat: 8.956526045261818, lng: 125.59551789945878, info: "Anex", image: "img/anex.jpg", link: "http://example.com/anex" },
      "osas": { lat: 8.956938598181836, lng: 125.5974861856326, info: "Osas", image: "img/osas.jpg", link: "http://example.com/osas" },
      "eco hall": { lat: 8.955018346783993, lng: 125.5969820861699, info: "Eco Hall", image: "img/ecohall.jpg", link: "http://example.com/osas" },
      "sports office": { lat: 8.955562274721453, lng: 125.59594834589646, info: "Sports Office", image: "img/sports.jpg", link: "sports.html" },
      "csu main gymnasium and cultural center": { lat: 8.955977741789837,  lng: 125.59566640516326, info: "CSU Main Gymnasium and Cultural Center", image: "img/img/gym.jpg", link: "gym.html" },
      "college of education (ced)": { lat: 8.959289352385552,   lng: 125.59702311903386, info: "College of Education (Ced)", image: "img/ced.jpg", link: "ced.html" },
      "ced canteen": { lat: 8.959464451759239, lng: 125.59725271438047, info: "CED Canteen", image: "img/cedcanteen.jpg", link: "ced-canteen.html" },
      "caa canteen": { lat: 8.959087604461281, lng: 125.59593194296626, info: "CAA Canteen", image: "img/caacanteen.jpg", link: "caa-canteen.html" },
      "cofes canteen": { lat: 8.953314087321177, lng: 125.59714493015973, info: "COFES Canteen", image: "img/osas.jpg", link: "cofes-canteen.html" },
      "department of science and technology caraga region(dost)": { lat: 8.953213412910166,  lng: 125.5982116566809, info: "Department of Science and Technology Caraga Region(DOST)", image: "img/dost.jpg", link: "dost.html" },
      "college of engineering and geosciences(cegs)": { lat: 8.954970254233311,  lng: 125.59793373424142, info: "College Engineering and Geosciences(CEGS)", image: "img/cegs.jpg", link: "cegs.html" },
      "masawa hall": { lat: 8.955532271257468, lng: 125.59851599862621, info: "Masawa Hall", image: "img/masawa.jpg", link: "masawa.html" },
      "college of agriculture and agri-industries (caa)": { lat: 8.9590, lng: 125.5957, info: "College of Agriculture and Agri-Industries (CAA)", image: "img/caa.jpg", link: "caa.html" },
      "caa greenhouse": { lat: 8.958930947394402, lng: 125.59506156797713, info: "CAA Greenhouse", image: "img/greenhouse.jpg", link: "caa-greenhouse.html" },
      "hostel building": { lat: 8.958735140337026,  lng: 125.59833326532635, info: "Hostel Building", image: "img/hostel.jpg", link: "hostel.html" },
      "csu personnel multipurpose cooperative canteen": { lat: 8.955626166710692, lng: 125.59704251248058, info: "CSU Personnel multipurpose cooperative canteen", image: "", link: "coo-canteen.html" },
      "clinic": { lat: 8.95865014355704,  lng: 125.59801501452652, info: "Clinic", image: "img/clinic.jpg", link: "hostel.html" },
    };

    const matchedLocations = Object.keys(searchLocations).filter(key => key.includes(searchInput));
    if (matchedLocations.length > 0) {
      if (matchedLocations.length === 1) {
        const locationData = searchLocations[matchedLocations[0]];
        const position = new google.maps.LatLng(locationData.lat, locationData.lng);
//customize dynamic marker
        const marker = new google.maps.Marker({
          position: position,
          map: map,
          icon: {
            url: "img/dynamic.png", // URL to your custom marker icon
            scaledSize: new google.maps.Size(45, 45), // Custom size
          },
        });

        const infoWindowContent = `
          <div style="width: 200px; text-align: center; overflow-wrap: break-word;">
            <a href="${locationData.link}">
              <img src="${locationData.image}" alt="${locationData.info}" style="max-width: 200px; height: 100px; margin-bottom: 10px; border-radius: 10px;">
            </a>
            <h6>${locationData.info}</h6>
             <p>${locationData.description}</p>
          </div>
        `;
        const infoWindow = new google.maps.InfoWindow({
          content: infoWindowContent,
        });

        infoWindows.forEach((iw) => iw.close());
        infoWindow.open(map, marker);
        map.panTo(position);
        map.setZoom(18);

        google.maps.event.addListener(infoWindow, 'closeclick', function () {
          marker.setMap(null);
        });

        marker.addListener("click", () => {
          infoWindow.open(map, marker);
        });

        // Add event listener to open link in new tab
      google.maps.event.addListener(infoWindow, 'domready', () => {
  const linkElement = document.querySelector(`a[href="${locationData.link}"]`);
  if (linkElement) {
    linkElement.addEventListener("click", (event) => {
      event.preventDefault();

      // Open link in a new tab
      const newTab = window.open(locationData.link, "_blank");

      // Focus back to the original tab when the new tab is closed
      if (newTab) {
        const checkTabClosed = setInterval(() => {
          if (newTab.closed) {
            clearInterval(checkTabClosed);
            window.focus();
          }
        }, 500);
      }
    });
  }
});

      } else {
        alert(`Multiple locations found: ${matchedLocations.map(loc => searchLocations[loc].info).join(", ")}`);
      }
    } else {
      alert('Location not found!');
    }
  }
}

// Modified getDirections function
async function getDirections() {
  const startInput = document.getElementById("start-input").value.trim().toLowerCase();
  const useMyLocation = document.getElementById("use-my-location").checked;
  const endInput = document.getElementById("end-input").value.trim().toLowerCase();

  let startLocation;
  const searchLocations = {
    // Predefined locations here ...
    "registrar": {  lat: 8.956943189494943, lng: 125.59745241416188, info: "Registrar", image: "img/registrar.jpg", link: "nsb-canteen.html" },
    "oas": {  lat: 8.95689685581763, lng: 125.59717054069868, info: "OAS", image: "img/oas.jpg", link: "nsb-canteen.html", description: "Office of admission and scholarship" },
    "food technology center": {  lat: 8.95885218261509,    lng: 125.59633765001367, info: "Food Technology Center", image: "img/canteen.jpg", link: "nsb-canteen.html" },
    "caraga food innovation center": {  lat: 8.958682057187627,   lng: 125.59588324874615, info: "Caraga Food Innovation Center", image: "img/canteen.jpg", link: "nsb-canteen.html" },
    "organic agriculture training center": {  lat: 8.953670505991782,  lng: 125.5971810025196, info: "Organic Agriculture Training Center", image: "img/oatc.jpg", link: "nsb-canteen.html" },
    "nsb canteen": {  lat: 8.958486428920668,  lng: 125.5972223715645, info: "NSB Canteen", image: "img/canteen.jpg", link: "nsb.html" },
    "cofes canteen": { lat: 8.953314087321177, lng: 125.59714493015973, info: "COFES Canteen", image: "img/osas.jpg", link: "cofes-canteen.html" },
    "new science building (nsb/batok hall)": {  lat:8.957890221298307,  lng: 125.5969669581597, info: "New Science building (NSB/Batok Hall)", image: "img/nsb.jpg", link: "nsb.html" },
    "csu main college of forestry and environmental sciences (cofes)": { lat: 8.9532, lng: 125.5972, info: "CSU Main College of Forestry and Environmental Sciences (COFES)", image: "img/cofes.jpg", link: "cofes.html" },
    "farm mechanization center": { lat: 8.957465490271211,  lng: 125.59814632842759, info: "Farm Mechanization Center", image: "img/farmmech.jpg", link: "farmmech.html" },
    "college of humanities and social sciences/kinaadman hall": { lat: 8.956091004584328, lng: 125.59792323787687, info: "College of Humanities and Social Sciences/Kinaadman Hall", image: "img/kinaadman.jpg", link: "chass.html" },
    "old administration building": { lat: 8.956825777829309,  lng: 125.59738154793322, info: "Old Administration Building", image: "img/oldadmin.jpg", link: "oldadmin.html" },
    "new administration building": { lat: 8.957250380365862,  lng: 125.59764832350852,  info: "New Administration Building", image: "img/admin.jpg", link: "admin.html" },
      "anex 2": { lat: 8.954527524733473, lng:  125.59807198444454, info: "Anex 2", image: "img/anex.jpg", link: "http://example.com/anex" },  
      "anex 3 building": { lat: 8.956476963908328, lng: 125.59541117924815, info: "Anex 3 Building", image: "img/anex.jpg", link: "anex1.html" },  
      "villares": { lat: 8.953157960469824,  lng: 125.59738112140803,  info: "CSU Villares Building", image: "img/cofes.jpg", link: "cofes.html" }, 
      "csu main hero learning commons": { lat: 8.95786387399443,  lng: 125.59635007361663, info: "CSU Main HERO Learning Commons", image: "img/library.jpg", link: "lib.html" },
      "old cas building": { lat: 8.955575598052341, lng: 125.59664046282884, info: "Old CAS Building", image: "img/oldcas.jpg", link: "oldcas.html" },
      "college of computing and information sciences (ccis)": { lat: 8.9554, lng: 125.5978, info: "College of Computing and Information Sciences (CCIS)", image: "img/ccis.jpg", link: "ccis.html" },
      "field": { lat: 8.956543619178424,  lng: 125.59649493048896, info: "Field", image: "img/oval.jpg", link: "field.html" },
      "boffo food hub canteen": { lat: 8.957376450320611, lng: 125.59566892198143, info: "Boffo Food Hub Canteen", image: "img/canteen.jpg", link: "bofo.html" },
      "anex": { lat: 8.956526045261818, lng: 125.59551789945878, info: "Anex", image: "img/anex.jpg", link: "http://example.com/anex" },
      "osas": { lat: 8.956938598181836, lng: 125.5974861856326, info: "Osas", image: "img/osas.jpg", link: "http://example.com/osas" },
      "eco hall": { lat: 8.955018346783993, lng: 125.5969820861699, info: "Eco Hall", image: "img/ecohall.jpg", link: "http://example.com/osas" },
      "sports office": { lat: 8.955562274721453, lng: 125.59594834589646, info: "Sports Office", image: "img/sports.jpg", link: "sports.html" },
      "csu main gymnasium and cultural center": { lat: 8.955977741789837,  lng: 125.59566640516326, info: "CSU Main Gymnasium and Cultural Center", image: "img/img/gym.jpg", link: "gym.html" },
      "college of education (ced)": { lat: 8.959289352385552,   lng: 125.59702311903386, info: "College of Education (Ced)", image: "img/ced.jpg", link: "ced.html" },
      "ced canteen": { lat: 8.959464451759239, lng: 125.59725271438047, info: "CED Canteen", image: "img/cedcanteen.jpg", link: "ced-canteen.html" },
      "caa canteen": { lat: 8.959087604461281, lng: 125.59593194296626, info: "CAA Canteen", image: "img/caacanteen.jpg", link: "caa-canteen.html" },
      "department of science and technology caraga region(dost)": { lat: 8.953213412910166,  lng: 125.5982116566809, info: "Department of Science and Technology Caraga Region(DOST)", image: "img/dost.jpg", link: "http://example.com/osas" },
      "college of engineering and geosciences(cegs)": { lat: 8.954970254233311,  lng: 125.59793373424142, info: "College Engineering and Geosciences(CEGS)", image: "img/cegs.jpg", link: "cegs.html" },
      "masawa hall": { lat: 8.955532271257468, lng: 125.59851599862621, info: "Masawa Hall", image: "img/masawa.jpg", link: "masawa.html" },
      "college of agriculture and agri-industries (caa)": { lat: 8.9590, lng: 125.5957, info: "College of Agriculture and Agri-Industries (CAA)", image: "img/caa.jpg", link: "caa.html" },
      "caa greenhouse": { lat: 8.958930947394402, lng: 125.59506156797713, info: "CAA Greenhouse", image: "img/greenhouse.jpg", link: "caa.html" },
      "hostel building": { lat: 8.958735140337026,  lng: 125.59833326532635, info: "Hostel Building", image: "img/hostel.jpg", link: "hostel.html" },
      "clinic": { lat: 8.95865014355704,  lng: 125.59801501452652, info: "Clinic", image: "img/clinic.jpg", link: "hostel.html" },
      "csu personnel multipurpose cooperative canteen": { lat: 8.955626166710692, lng: 125.59704251248058, info: "CSU Personnel multipurpose cooperative canteen", image: "", link: "coo-canteen.html" },
  };

  try {
    // Determine start location
    if (useMyLocation) {
      const currentLocation = await getCurrentLocation();
      startLocation = new google.maps.LatLng(currentLocation.lat, currentLocation.lng);
    } else if (searchLocations[startInput]) {
      const locationData = searchLocations[startInput];
      startLocation = new google.maps.LatLng(locationData.lat, locationData.lng);
    } else {
      alert('Start location not found!');
      return;
    }

    // Remove existing dynamic markers from the map
    dynamicMarkers.forEach(marker => marker.setMap(null));
    dynamicMarkers = []; // Clear the array

    // Create a new dynamic marker for start location
    if (searchLocations[startInput]) {
      const locationData = searchLocations[startInput];
      const position = new google.maps.LatLng(locationData.lat, locationData.lng);
      const marker = new google.maps.Marker({
        position: position,
        map: map,
        icon: {
          url: "img/dynamic.png",
          scaledSize: new google.maps.Size(45, 45),
        },
      });

      // Add InfoWindow for start location
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="width: 200px; text-align: center; overflow-wrap: break-word;">
            <a href="${locationData.link}" target="_blank">
              <img src="${locationData.image}" alt="${locationData.info}" style="width: 200px; height: 100px; margin-bottom: 10px; border-radius: 10px;">
            </a>
            <h6>${locationData.info}</h6>
            <p>${locationData.description}</p>
          </div>
        `,
      });

      
        infoWindow.open(map, marker);
        // When closing the info window, close the marker too
        google.maps.event.addListener(infoWindow, 'closeclick', () => {
          marker.setMap(null); // Remove marker when info window is closed
          dynamicMarkers = dynamicMarkers.filter(m => m !== marker); // Remove marker from array
        });
      

      dynamicMarkers.push(marker); // Add to dynamicMarkers array
    }

    // Create a new dynamic marker for end location
    if (searchLocations[endInput]) {
      const locationData = searchLocations[endInput];
      const position = new google.maps.LatLng(locationData.lat, locationData.lng);
      const marker = new google.maps.Marker({
        position: position,
        map: map,
        icon: {
          url: "img/dynamic.png",
          scaledSize: new google.maps.Size(45, 45),
        },
      });

      // Add InfoWindow for end location
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="width: 200px; text-align: center; overflow-wrap: break-word;">
            <a href="${locationData.link}" target="_blank">
              <img src="${locationData.image}" alt="${locationData.info}" style="width: 200px; height: 100px; margin-bottom: 10px; border-radius: 10px;">
            </a>
            <h6>${locationData.info}</h6>
            <p>${locationData.description}</p>
          </div>
        `,
      });

      
        infoWindow.open(map, marker);
        // When closing the info window, close the marker too
        google.maps.event.addListener(infoWindow, 'closeclick', () => {
          marker.setMap(null); // Remove marker when info window is closed
          dynamicMarkers = dynamicMarkers.filter(m => m !== marker); // Remove marker from array
        });

         // Add event listener to open link in new tab
         google.maps.event.addListener(infoWindow, 'domready', () => {
          const linkElement = document.querySelector(`a[href="${locationData.link}"]`);
          if (linkElement) {
            linkElement.addEventListener("click", (event) => {
              event.preventDefault();
        
              // Open the link in a new tab
              const newTab = window.open(locationData.link, "_blank");
        
              // If the new tab was opened successfully, check when it's closed
              if (newTab) {
                const checkTabClosed = setInterval(() => {
                  if (newTab.closed) {
                    clearInterval(checkTabClosed);
                    window.focus(); // Bring focus back to the original tab
                  }
                }, 500);
              }
            });
          }
        });
        
      

      dynamicMarkers.push(marker); // Add to dynamicMarkers array
    } else {
      alert('End location not found!');
      return;
    }

    // Get directions if dynamic markers exist
    if (dynamicMarkers.length > 0) {
      const endMarker = dynamicMarkers[dynamicMarkers.length - 1]; // Use the last dynamic marker for directions

      const request = {
        origin: startLocation,
        destination: endMarker.getPosition(),
        travelMode: 'WALKING',
      };

      directionsService.route(request, function (result, status) {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
        } else {
          alert('Directions request failed due to ' + status);
        }
      });
    }
  } catch (error) {
    alert('Failed to get directions: ' + error.message);
  }
}

navigator.geolocation.getCurrentPosition(function (position) {
  const userLocation = {
    lat: position.coords.latitude,
    lng: position.coords.longitude
  };

  // Add a marker for the user's location with a custom icon
  new google.maps.Marker({
    position: userLocation,
    map: map,
    title: "You are here",
    icon: {
      url: "img/user.png", // Replace this with the path to your custom marker icon
      scaledSize: new google.maps.Size(50, 50), // Optional: Adjust the size of the icon
    },
  });
});

// Function to get user's current location
function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          resolve({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        },
        (error) => {
          reject(error);
        }
      );
    } else {
      reject(new Error('Geolocation is not supported by this browser.'));
    }
  });
}

//Auto complete locations
const inputFields = ["search-input", "start-input", "end-input"]; // IDs of the input fields
const predefinedLocations = [
  { name: "New Administration Building" },
  { name: "College of Education (Ced)" },
  { name: "CSU Main HERO Learning Commons"},
  { name: "Old CAS building" },
  { name: "College of computing and information sciences (CCIS)" },
  { name: "Department of Science and Technology Caraga Region(DOST)" },
  { name: "OSAS" },
  { name: "Clinic" },
  { name: "Eco Hall"},
  { name: "Masawa Hall"},
  { name: "CSU Main Gymnasium and Cultural Center" },
  { name: "College of Engineering and Geosciences(CEGS)" },
  { name: "College of Agriculture and Agri-Industries (CAA)" },
  { name: "Field"},
  { name: "CED Canteen"},
  { name: "CAA Canteen"},
  { name: "CAA Greenhouse"},
  { name: "College of Humanities and Social Sciences/Kinaadman Hall"},
  { name: "Farm Mechanization Center"},
  { name: "Boffo Food Hub Canteen"},
  { name: "Hostel Building"},
  { name: "Old Administration Building"},
  { name: "CSU Personnel multipurpose cooperative canteen"},
  { name: "CSU Main College of Forestry and Environmental Sciences (COFES)"},
  { name: "New Science Building (NSB/Batok Hall)"},
  { name: "Sports Office"},
  { name: "Anex 3 Building"},
  { name: "NSB Canteen"},
  { name: "COFES Canteen"},
  { name: "Organic Agriculture Training Center"},
  { name: "Caraga Food Innovation Center"},
  { name: "Food Technology Center"},
  { name: "Registrar"},
  { name: "OAS"},
  { name: "CSU Villares Building"},
];

// Function to apply autocomplete functionality to an input field
function applyAutocomplete(inputId) {
    const inputField = document.getElementById(inputId);
    const dropdown = document.createElement("div");
    dropdown.classList.add("autocomplete-dropdown");
    inputField.parentNode.appendChild(dropdown);

    function updateDropdown() {
        const value = inputField.value.toLowerCase();
        dropdown.innerHTML = ""; // Clear previous suggestions

        // Filter locations based on input value
        const matchedLocations = predefinedLocations
            .filter(location => location.name.toLowerCase().includes(value))
            .slice(0, 5); // Limit to 5 results

        matchedLocations.forEach(location => {
            const item = document.createElement("div");
            item.classList.add("autocomplete-dropdown-item");
            item.textContent = location.name;

            // Using mousedown to capture touchpad and touchscreen events
            item.addEventListener("mousedown", () => {
                inputField.value = location.name;
                dropdown.innerHTML = ""; // Hide dropdown after selection
                // Additional functionality like placing marker on map can be added here
            });

            // Supporting touch devices with touchstart event
            item.addEventListener("touchstart", () => {
                inputField.value = location.name;
                dropdown.innerHTML = ""; // Hide dropdown after selection
            });

            dropdown.appendChild(item);
        });

        // Show dropdown if there are matches, hide it otherwise
        dropdown.style.display = matchedLocations.length ? "block" : "none";
    }

    inputField.addEventListener("input", updateDropdown);

    inputField.addEventListener("blur", () => {
        setTimeout(() => dropdown.style.display = "none", 150); // Delay to allow click
    });

    inputField.addEventListener("focus", updateDropdown);
}
// Apply autocomplete to each input field
inputFields.forEach(applyAutocomplete);

document.getElementById("search-button").addEventListener("click", searchLocation);
document.getElementById("directions-button").addEventListener("click", getDirections);
document.getElementById("clear-directions-button").addEventListener("click", clearDirections);

function clearDirections() {
  directionsRenderer.setDirections({ routes: [] });
  map.setCenter({ lat: 8.957188363048896,  lng: 125.59694453261423  }); // Center back to default
  map.setZoom(17); // Reset zoom if needed
}

initMap();



// Global variable for user marker
let userMarker;

// Modified getCurrentLocation function
function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    if (navigator.geolocation) {
      // Use watchPosition for continuous updates
      navigator.geolocation.watchPosition(
        (position) => {
          const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          // Create marker if it doesn't exist
          if (!userMarker) {
            userMarker = new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "You are here",
              icon: {
                url: "img/user.png",
                scaledSize: new google.maps.Size(50, 50),
              },
            });
          } else {
            // Update existing marker position
            userMarker.setPosition(userLocation);
          }

          resolve(userLocation);
        },
        (error) => {
          reject(error);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 30000,
          timeout: 27000
        }
      );
    } else {
      reject(new Error('Geolocation is not supported by this browser.'));
    }
  });
}